
var async = require('async');

var divider = require('../');


describe('User', function() {

    it('should save without error', function(done) {
        var store = divider({ part: 5 * 1024 * 1024, concurrency: 5 });

        setInterval(function() {
            console.log('>>>', store.getConcurrency());
        }, 1000);

        var sent = 0;
        var got = 0;

        store.on('part', function(part, next) {

            setTimeout(function() {
                got += part.data.length;
                console.log('part', part.index, part.data.length);
                next();
            }, part.index * 100);

        });

        //var list = [500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 500, 0];
        var list = new Array(100000);
        list.push(0);

        async.eachSeries(list, function(size, next) {
            if (size === 0) {
                return store.finish(next);
            }

            var data = new Buffer(64 * 1024);
            sent += data.length;

            store.write(data, next);

        }, function(err) {
            console.log('DONE!', sent, got);
            done();
        });

    });

});